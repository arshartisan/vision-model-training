generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Detection {
  id               String        @id @default(uuid())
  timestamp        DateTime      @default(now())

  // Frame metadata
  frameWidth       Int
  frameHeight      Int
  processingTimeMs Float

  // Detection counts (all detected crystals)
  pureCount        Int
  impureCount      Int
  totalCount       Int
  purityPercentage Float

  // ROI-filtered counts (only crystals inside ROI)
  roiPureCount        Int      @default(0)
  roiImpureCount      Int      @default(0)
  roiTotalCount       Int      @default(0)
  roiPurityPercentage Float?

  // Whiteness metrics (all detected crystals)
  avgWhiteness        Float?
  avgQualityScore     Float?

  // ROI-filtered whiteness metrics
  roiAvgWhiteness     Float?
  roiAvgQualityScore  Float?

  // Session tracking
  sessionId        String?
  session          DetectionSession? @relation(fields: [sessionId], references: [id])

  // Batch tracking
  batchId          String?
  batch            Batch?    @relation(fields: [batchId], references: [id])

  // Relationships
  boundingBoxes    BoundingBox[]

  @@index([timestamp])
  @@index([sessionId])
  @@index([batchId])
  @@index([purityPercentage])
}

model BoundingBox {
  id          String    @id @default(uuid())
  detectionId String
  detection   Detection @relation(fields: [detectionId], references: [id], onDelete: Cascade)

  // Box coordinates (normalized 0-1)
  x           Float     // top-left x
  y           Float     // top-left y
  width       Float
  height      Float

  // Classification
  classId     Int       // 0 = pure, 1 = impure
  className   String    // "pure" or "impure"
  confidence  Float     // 0-1

  // Whiteness metrics
  whitenessPercentage  Float?    // 0-100, whiteness of crystal region
  qualityScore         Float?    // 0-100, combined score (isPure ? 1 : 0.3) * whiteness

  @@index([detectionId])
  @@index([classId])
}

model DetectionSession {
  id               String      @id @default(uuid())
  startTime        DateTime    @default(now())
  endTime          DateTime?

  // Session statistics
  totalFrames      Int         @default(0)
  totalPureCount   Int         @default(0)
  totalImpureCount Int         @default(0)
  avgPurityPercent Float?
  totalBatches     Int         @default(0)

  // Session-level whiteness tracking
  avgWhiteness     Float?
  avgQualityScore  Float?

  // ROI configuration for the session (normalized 0-1)
  roiX             Float       @default(0.05)
  roiY             Float       @default(0.05)
  roiWidth         Float       @default(0.9)
  roiHeight        Float       @default(0.9)

  // Session metadata
  cameraSource     String?
  notes            String?

  // Relationships
  detections       Detection[]
  batches          Batch[]

  @@index([startTime])
}

model Batch {
  id               String           @id @default(uuid())
  sessionId        String
  session          DetectionSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  batchNumber      Int              // Sequential number within session
  startTime        DateTime         @default(now())
  endTime          DateTime?

  // ROI settings used for this batch (normalized 0-1)
  roiX             Float
  roiY             Float
  roiWidth         Float
  roiHeight        Float

  // Batch statistics (only crystals inside ROI)
  pureCount        Int              @default(0)
  impureCount      Int              @default(0)
  totalCount       Int              @default(0)
  purityPercentage Float?

  // Batch-level whiteness metrics
  avgWhiteness     Float?
  avgQualityScore  Float?

  // Frame count for this batch
  frameCount       Int              @default(0)

  // Relationships
  detections       Detection[]

  @@index([sessionId])
  @@index([startTime])
  @@index([batchNumber])
}
